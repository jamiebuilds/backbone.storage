{"version":3,"file":"backbone.storage.js","sources":["backbone.storage.js","/source/backbone.storage.js"],"names":["global","factory","exports","module","require","define","amd","Backbone","Storage","Metal","this","Class","extend","model","Model","collection","Collection","constructor","records","listenToOnce","_this","_hasSynced","_super","apply","arguments","find","forceFetch","undefined","record","get","Promise","resolve","_ensureModel","fetch","then","insert","findAll","options","save","add","merge","id","backbone_storage"],"mappings":"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","sourceRoot":"/source/","sourcesContent":["(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory(require('backbone'), require('backbone-metal')) :\n  typeof define === 'function' && define.amd ? define(['backbone', 'backbone-metal'], factory) :\n  global.Backbone.Storage = factory(global.Backbone, global.Metal)\n}(this, function (Backbone, Metal) { 'use strict';\n\n  var Storage = Backbone.Storage = Metal.Class.extend({\n\n    /**\n     * The model class to store.\n     * @type {Backbone.Model}\n     */\n    model: Backbone.Model,\n\n    /**\n     * The collection class to store.\n     * @type {Backbone.Collection}\n     */\n    collection: Backbone.Collection,\n\n    /**\n     * @public\n     * @constructs Storage\n     */\n    constructor() {\n      this.records = new this.collection();\n      this.listenToOnce(this.records, 'sync', () => {\n        this._hasSynced = true;\n      });\n      this._super.apply(this, arguments);\n    },\n\n    /**\n     * Find a specific model from the store or fetch it from the server and insert\n     * it into the store.\n     *\n     * @public\n     * @instance\n     * @method find\n     * @memberOf Storage\n     * @param {Number|String|Object|Backbone.Model} model - The model to find.\n     * @param {Boolean} forceFetch - Force fetch model from server.\n     * @returns {Promise} - A promise that will resolve to the model.\n     */\n    find(model, forceFetch = false) {\n      let record = this.records.get(model);\n\n      if (record && !forceFetch) {\n        return Promise.resolve(record);\n      } else {\n        model = this._ensureModel(model);\n        return Promise.resolve(model.fetch()).then(() => {\n          return this.insert(model);\n        });\n      }\n    },\n\n    /**\n     * Find all the models in the store or fetch them from the server if they\n     * haven't been fetched before.\n     *\n     * @public\n     * @instance\n     * @method findAll\n     * @memberOf Storage\n     * @param {Object} options - Options to pass to collection fetch. Also allows\n     * setting parameters on collection.\n     * @param {Boolean} forceFetch - Force fetch model from server.\n     * @returns {Promise} - A promise that will resolve to the entire collection.\n     */\n    findAll(options = {}, forceFetch = false) {\n      if (this._hasSynced && !forceFetch) {\n        return Promise.resolve(this.records);\n      } else {\n        return Promise.resolve(this.records.fetch(options)).then(() => {\n          return this.records;\n        });\n      }\n    },\n\n    /**\n     * Save a model to the server.\n     *\n     * @public\n     * @instance\n     * @method save\n     * @memberOf Storage\n     * @param {Number|String|Object|Backbone.Model} model - The model to save\n     * @returns {Promise} - A promise that will resolve to the saved model.\n     */\n    save(model) {\n      let record = this.records.get(model);\n      model = record || this._ensureModel(model);\n      return Promise.resolve(model.save()).then(() => {\n        if (!record) {\n          this.insert(model);\n        }\n        return model;\n      });\n    },\n\n    /**\n     * Insert a model into the store.\n     *\n     * @public\n     * @instance\n     * @method insert\n     * @memberOf Storage\n     * @params {Object|Backbone.Model} - The model to add.\n     * @returns {Promise} - A promise that will resolve to the added model.\n     */\n    insert(model) {\n      model = this.records.add(model, { merge: true });\n      return Promise.resolve(model);\n    },\n\n    /**\n     * Ensure that we have a real model from an id, object, or model.\n     *\n     * @private\n     * @instance\n     * @method _ensureModel\n     * @memberOf Storage\n     * @params {Number|String|Object|Backbone.Model} - An id, object, or model.\n     * @returns {Backbone.Model} - The model.\n     */\n    _ensureModel(model) {\n      if (model instanceof this.model) {\n        return model;\n      } else if (typeof model === 'object') {\n        return new this.model(model);\n      } else {\n        return new this.model({ id: model });\n      }\n    }\n  });\n\n  var backbone_storage = Storage;\n\n  return backbone_storage;\n\n}));\n","(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory(require('backbone'), require('backbone-metal')) :\n  typeof define === 'function' && define.amd ? define(['backbone', 'backbone-metal'], factory) :\n  global.Backbone.Storage = factory(global.Backbone, global.Metal)\n}(this, function (Backbone, Metal) { 'use strict';\n\n  var Storage = Backbone.Storage = Metal.Class.extend({\n\n    /**\n     * The model class to store.\n     * @type {Backbone.Model}\n     */\n    model: Backbone.Model,\n\n    /**\n     * The collection class to store.\n     * @type {Backbone.Collection}\n     */\n    collection: Backbone.Collection,\n\n    /**\n     * @public\n     * @constructs Storage\n     */\n    constructor() {\n      this.records = new this.collection();\n      this.listenToOnce(this.records, 'sync', () => {\n        this._hasSynced = true;\n      });\n      this._super.apply(this, arguments);\n    },\n\n    /**\n     * Find a specific model from the store or fetch it from the server and insert\n     * it into the store.\n     *\n     * @public\n     * @instance\n     * @method find\n     * @memberOf Storage\n     * @param {Number|String|Object|Backbone.Model} model - The model to find.\n     * @param {Boolean} forceFetch - Force fetch model from server.\n     * @returns {Promise} - A promise that will resolve to the model.\n     */\n    find(model, forceFetch = false) {\n      let record = this.records.get(model);\n\n      if (record && !forceFetch) {\n        return Promise.resolve(record);\n      } else {\n        model = this._ensureModel(model);\n        return Promise.resolve(model.fetch()).then(() => {\n          return this.insert(model);\n        });\n      }\n    },\n\n    /**\n     * Find all the models in the store or fetch them from the server if they\n     * haven't been fetched before.\n     *\n     * @public\n     * @instance\n     * @method findAll\n     * @memberOf Storage\n     * @param {Object} options - Options to pass to collection fetch. Also allows\n     * setting parameters on collection.\n     * @param {Boolean} forceFetch - Force fetch model from server.\n     * @returns {Promise} - A promise that will resolve to the entire collection.\n     */\n    findAll(options = {}, forceFetch = false) {\n      if (this._hasSynced && !forceFetch) {\n        return Promise.resolve(this.records);\n      } else {\n        return Promise.resolve(this.records.fetch(options)).then(() => {\n          return this.records;\n        });\n      }\n    },\n\n    /**\n     * Save a model to the server.\n     *\n     * @public\n     * @instance\n     * @method save\n     * @memberOf Storage\n     * @param {Number|String|Object|Backbone.Model} model - The model to save\n     * @returns {Promise} - A promise that will resolve to the saved model.\n     */\n    save(model) {\n      let record = this.records.get(model);\n      model = record || this._ensureModel(model);\n      return Promise.resolve(model.save()).then(() => {\n        if (!record) {\n          this.insert(model);\n        }\n        return model;\n      });\n    },\n\n    /**\n     * Insert a model into the store.\n     *\n     * @public\n     * @instance\n     * @method insert\n     * @memberOf Storage\n     * @params {Object|Backbone.Model} - The model to add.\n     * @returns {Promise} - A promise that will resolve to the added model.\n     */\n    insert(model) {\n      model = this.records.add(model, { merge: true });\n      return Promise.resolve(model);\n    },\n\n    /**\n     * Ensure that we have a real model from an id, object, or model.\n     *\n     * @private\n     * @instance\n     * @method _ensureModel\n     * @memberOf Storage\n     * @params {Number|String|Object|Backbone.Model} - An id, object, or model.\n     * @returns {Backbone.Model} - The model.\n     */\n    _ensureModel(model) {\n      if (model instanceof this.model) {\n        return model;\n      } else if (typeof model === 'object') {\n        return new this.model(model);\n      } else {\n        return new this.model({ id: model });\n      }\n    }\n  });\n\n  var backbone_storage = Storage;\n\n  return backbone_storage;\n\n}));\n"]}